#!/bin/bash

# Enable Docker BuildKit for faster builds and advanced features
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# Update the local repository with changes from the remote server
echo "Running git pull..."
git pull

# Check if the previous command was successful
if [ $? -eq 0 ]; then
    echo "Git pull successful. Building Docker image..."
    echo "BuildKit: enabled (faster builds with layer caching)"
    echo ""

    # Build the docker images
    # BuildKit will cache apt and pip downloads for much faster rebuilds
    sudo docker compose build

    if [ $? -eq 0 ]; then
        echo ""
        echo "Build successful!"
    else
        echo "Docker build failed!"
        exit 1
    fi
else
    echo "Git pull failed. Aborting build."
    exit 1
fi

echo "Process completed."
